# 测试计划

## 1. 测试概述

### 1.1 测试目标
- 确保系统功能正确性
- 验证性能指标达标
- 保证系统稳定性
- 测试覆盖率≥80%

### 1.2 测试范围
- **功能测试**: 所有功能模块
- **性能测试**: 延迟、吞吐量、并发
- **集成测试**: 模块间协作
- **压力测试**: 系统极限能力
- **GPU测试**: GPU功能、性能、回退机制

### 1.3 测试环境
- **开发环境**: 本地开发测试
- **测试环境**: Docker容器环境
- **性能测试环境**: 独立服务器
- **GPU测试环境**: 支持NVIDIA GPU的服务器（可选）

## 2. 测试策略

### 2.1 测试金字塔
```
        /\
       /  \
      / E2E \        少量端到端测试
     /------\
    /        \
   / Integration \  适量集成测试
  /--------------\
 /                \
/   Unit Tests     \  大量单元测试
/------------------\
```

### 2.2 测试阶段
1. **单元测试**: 开发阶段
2. **集成测试**: 功能完成后
3. **系统测试**: 版本发布前
4. **验收测试**: 发布前最终验证

## 3. 单元测试计划

### 3.1 测试范围
- 所有导出函数
- 所有业务逻辑
- 所有工具函数

### 3.2 测试用例

#### 3.2.1 ASR模块测试
```go
// internal/asr/provider_test.go
func TestASRProvider_Transcribe(t *testing.T) {
    // 测试用例1: 正常音频识别
    // 测试用例2: 空音频数据
    // 测试用例3: 无效音频格式
    // 测试用例4: 模型加载失败
    // 测试用例5: 识别超时
}

func TestASRProvider_GetSampleRate(t *testing.T) {
    // 测试用例1: 获取采样率
}

func TestASRProvider_Release(t *testing.T) {
    // 测试用例1: 正常释放资源
    // 测试用例2: 重复释放
}
```

#### 3.2.2 TTS模块测试
```go
// internal/tts/provider_test.go
func TestTTSProvider_Synthesize(t *testing.T) {
    // 测试用例1: 正常文本合成
    // 测试用例2: 空文本
    // 测试用例3: 超长文本
    // 测试用例4: 无效说话人ID
    // 测试用例5: 合成超时
}

func TestTTSProvider_GetSampleRate(t *testing.T) {
    // 测试用例1: 获取采样率
}
```

#### 3.2.3 会话管理测试
```go
// internal/common/session/manager_test.go
func TestSessionManager_CreateSession(t *testing.T) {
    // 测试用例1: 创建会话
    // 测试用例2: 会话ID冲突
    // 测试用例3: 达到最大会话数
}

func TestSessionManager_RemoveSession(t *testing.T) {
    // 测试用例1: 删除会话
    // 测试用例2: 删除不存在的会话
}
```

#### 3.2.4 WebSocket测试
```go
// internal/common/ws/handler_test.go
func TestWebSocketHandler_HandleConnection(t *testing.T) {
    // 测试用例1: 正常连接
    // 测试用例2: 连接失败
    // 测试用例3: 认证失败
}

func TestWebSocketHandler_HandleMessage(t *testing.T) {
    // 测试用例1: 正常消息处理
    // 测试用例2: 无效消息格式
    // 测试用例3: 消息过大
}
```

### 3.3 覆盖率目标
- **总体覆盖率**: ≥80%
- **核心模块覆盖率**: ≥90%
- **工具函数覆盖率**: ≥85%

### 3.4 测试执行
```bash
# 运行所有单元测试
go test ./...

# 运行特定包的测试
go test ./internal/asr

# 查看覆盖率
go test -cover ./...

# 生成覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

## 4. 集成测试计划

### 4.1 测试范围
- STT服务完整流程
- TTS服务完整流程
- WebSocket通信
- REST API调用
- 数据库操作

### 4.2 测试用例

#### 4.2.1 STT服务集成测试
```go
// test/integration/stt_test.go
func TestSTTService_EndToEnd(t *testing.T) {
    // 1. 启动STT服务
    server := startSTTServer(t)
    defer server.Close()
    
    // 2. 测试文件上传识别
    result := testFileUpload(t, server.URL)
    assert.NotEmpty(t, result.Text)
    
    // 3. 测试WebSocket实时识别
    result = testWebSocketRecognition(t, server.URL)
    assert.NotEmpty(t, result.Text)
    
    // 4. 测试批量识别
    results := testBatchRecognition(t, server.URL)
    assert.Equal(t, 3, len(results))
}
```

#### 4.2.2 TTS服务集成测试
```go
// test/integration/tts_test.go
func TestTTSService_EndToEnd(t *testing.T) {
    // 1. 启动TTS服务
    server := startTTSServer(t)
    defer server.Close()
    
    // 2. 测试文本合成
    audio := testSynthesize(t, server.URL, "测试文本")
    assert.NotEmpty(t, audio)
    
    // 3. 测试WebSocket合成
    audio = testWebSocketSynthesize(t, server.URL, "测试文本")
    assert.NotEmpty(t, audio)
    
    // 4. 测试批量合成
    audios := testBatchSynthesize(t, server.URL, []string{"文本1", "文本2"})
    assert.Equal(t, 2, len(audios))
}
```

#### 4.2.3 WebSocket集成测试
```go
// test/integration/websocket_test.go
func TestWebSocket_STT(t *testing.T) {
    server := startServer(t)
    defer server.Close()
    
    // 1. 建立连接
    conn := connectWebSocket(t, server.URL+"/ws")
    defer conn.Close()
    
    // 2. 发送音频数据
    audioData := loadTestAudio(t)
    err := conn.WriteMessage(websocket.BinaryMessage, audioData)
    assert.NoError(t, err)
    
    // 3. 接收识别结果
    _, message, err := conn.ReadMessage()
    assert.NoError(t, err)
    
    var result RecognitionResult
    err = json.Unmarshal(message, &result)
    assert.NoError(t, err)
    assert.NotEmpty(t, result.Text)
}
```

### 4.3 测试环境
- 使用Docker Compose搭建测试环境
- 包含所有依赖服务
- 测试数据隔离

### 4.4 测试执行
```bash
# 启动测试环境
docker-compose -f docker-compose.test.yml up -d

# 运行集成测试
go test -tags=integration ./test/integration/...

# 清理测试环境
docker-compose -f docker-compose.test.yml down
```

## 5. 功能测试计划

### 5.1 测试范围
- 所有用户功能
- 所有API接口
- Web界面功能

### 5.2 测试用例

#### 5.2.1 STT功能测试
| 功能 | 测试用例 | 预期结果 |
|------|---------|---------|
| 文件上传识别 | 上传WAV文件 | 返回识别文本 |
| 文件上传识别 | 上传MP3文件 | 返回识别文本 |
| 文件上传识别 | 上传空文件 | 返回错误 |
| 文件上传识别 | 上传无效格式 | 返回错误 |
| WebSocket实时识别 | 发送音频流 | 实时返回识别结果 |
| WebSocket实时识别 | 连接断开 | 自动重连 |
| 批量识别 | 上传多个文件 | 返回所有识别结果 |
| 批量识别 | 部分文件失败 | 返回成功和失败结果 |

#### 5.2.2 TTS功能测试
| 功能 | 测试用例 | 预期结果 |
|------|---------|---------|
| 文本合成 | 输入中文文本 | 返回音频文件 |
| 文本合成 | 输入英文文本 | 返回音频文件 |
| 文本合成 | 输入空文本 | 返回错误 |
| 文本合成 | 输入超长文本 | 返回错误或截断 |
| 参数调整 | 调整语速 | 音频时长变化 |
| 参数调整 | 调整说话人 | 音频音色变化 |
| WebSocket合成 | 发送文本 | 实时返回音频流 |
| 批量合成 | 输入多个文本 | 返回所有音频 |

#### 5.2.3 Web界面测试
| 功能 | 测试用例 | 预期结果 |
|------|---------|---------|
| STT测试页面 | 点击录音按钮 | 开始录音 |
| STT测试页面 | 停止录音 | 显示识别结果 |
| STT测试页面 | 上传文件 | 显示识别结果 |
| TTS测试页面 | 输入文本 | 生成音频 |
| TTS测试页面 | 播放音频 | 正常播放 |
| 监控页面 | 查看指标 | 显示实时数据 |
| 监控页面 | 查看图表 | 显示趋势图 |

### 5.3 测试执行
- 手动测试
- 自动化测试脚本
- 测试报告

## 6. 性能测试计划

### 6.1 测试指标
- **延迟**: P50, P95, P99
- **吞吐量**: QPS
- **并发数**: 最大并发连接数
- **资源使用**: CPU, 内存

### 6.2 测试场景

#### 6.2.1 STT性能测试
| 场景 | 指标 | 目标值 |
|------|------|--------|
| 单次识别延迟 | P95延迟 | <400ms |
| 单次识别延迟 | P99延迟 | <600ms |
| 并发识别 | QPS | >10 |
| 并发识别 | 最大并发 | >100 |
| 资源使用 | CPU使用率 | <80% |
| 资源使用 | 内存使用 | <2GB |

#### 6.2.2 TTS性能测试
| 场景 | 指标 | 目标值 |
|------|------|--------|
| 单次合成时间 | 5秒音频 | <5s |
| 并发合成 | 最大并发 | >10 |
| 资源使用 | CPU使用率 | <90% |
| 资源使用 | 内存使用 | <2GB |

### 6.3 测试工具
- **go test -bench**: Go内置基准测试
- **JMeter**: 压力测试工具
- **wrk**: HTTP压力测试工具
- **pprof**: 性能分析工具

### 6.4 测试脚本
```bash
# STT性能测试
go test -bench=BenchmarkSTT -benchmem ./test/performance/

# TTS性能测试
go test -bench=BenchmarkTTS -benchmem ./test/performance/

# HTTP压力测试
wrk -t4 -c100 -d30s http://localhost:8080/api/v1/stt/recognize
```

## 7. 压力测试计划

### 7.1 测试场景
- **正常负载**: 预期QPS的50%
- **峰值负载**: 预期QPS的100%
- **超载测试**: 预期QPS的150%
- **极限测试**: 系统最大承受能力

### 7.2 测试用例

#### 7.2.1 并发连接测试
```go
func TestConcurrentConnections(t *testing.T) {
    const numConnections = 100
    const duration = 30 * time.Second
    
    server := startServer(t)
    defer server.Close()
    
    var wg sync.WaitGroup
    errors := make(chan error, numConnections)
    
    for i := 0; i < numConnections; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            conn := connectWebSocket(t, server.URL+"/ws")
            defer conn.Close()
            
            // 持续发送数据
            ticker := time.NewTicker(100 * time.Millisecond)
            defer ticker.Stop()
            
            deadline := time.Now().Add(duration)
            for time.Now().Before(deadline) {
                select {
                case <-ticker.C:
                    if err := sendAudioData(conn); err != nil {
                        errors <- err
                        return
                    }
                }
            }
        }(i)
    }
    
    wg.Wait()
    close(errors)
    
    errorCount := 0
    for err := range errors {
        if err != nil {
            errorCount++
        }
    }
    
    errorRate := float64(errorCount) / float64(numConnections)
    assert.Less(t, errorRate, 0.05, "error rate should be less than 5%")
}
```

#### 7.2.2 长时间运行测试
```go
func TestLongRunning(t *testing.T) {
    const duration = 1 * time.Hour
    
    server := startServer(t)
    defer server.Close()
    
    // 持续运行1小时
    // 监控内存泄漏
    // 监控性能下降
}
```

### 7.3 测试工具
- **JMeter**: 压力测试脚本
- **wrk**: HTTP压力测试
- **自定义工具**: Go编写的压力测试工具

## 8. 安全测试计划

### 8.1 测试范围
- 输入验证
- 认证授权
- 资源限制
- 数据安全

### 8.2 测试用例
- **SQL注入**: 测试输入验证
- **XSS攻击**: 测试输出转义
- **CSRF攻击**: 测试Token验证
- **DoS攻击**: 测试限流机制
- **认证绕过**: 测试认证机制

## 9. 兼容性测试计划

### 9.1 浏览器兼容性
- Chrome (最新版)
- Firefox (最新版)
- Safari (最新版)
- Edge (最新版)

### 9.2 操作系统兼容性
- Linux (Ubuntu 20.04+)
- macOS (10.15+)
- Windows (10+)

### 9.3 Go版本兼容性
- Go 1.21+
- Go 1.22+

## 10. 测试执行计划

### 10.1 测试时间表
| 阶段 | 时间 | 测试类型 |
|------|------|---------|
| 开发阶段 | 持续 | 单元测试 |
| 功能完成 | 每周 | 集成测试 |
| 版本发布前 | 1周 | 系统测试 |
| 发布前 | 3天 | 验收测试 |

### 10.2 测试资源
- **测试人员**: 1-2人
- **测试环境**: Docker容器
- **测试工具**: Go test, JMeter, wrk
- **测试数据**: 预准备的测试音频和文本

### 10.3 测试报告
- 测试执行报告
- 测试结果汇总
- Bug报告
- 性能测试报告
- 测试覆盖率报告

## 11. 测试验收标准

### 11.1 功能验收
- 所有功能测试通过
- 无严重bug
- 无阻塞性bug

### 11.2 性能验收
- 延迟指标达标
- 吞吐量指标达标
- 并发能力达标

### 11.3 质量验收
- 测试覆盖率≥80%
- 代码审查通过
- 文档完整

## 12. 测试工具和环境

### 12.1 测试工具
- **Go test**: 单元测试和基准测试
- **testify**: 断言库
- **httptest**: HTTP测试
- **JMeter**: 压力测试
- **wrk**: HTTP压力测试
- **pprof**: 性能分析

### 12.2 测试环境
- **Docker Compose**: 集成测试环境
- **独立服务器**: 性能测试环境
- **CI/CD**: 自动化测试环境

### 12.3 测试数据
- **音频文件**: 多种格式、多种语言
- **文本数据**: 多种长度、多种语言
- **测试脚本**: 自动化测试脚本

