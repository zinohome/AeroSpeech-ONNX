# 架构设计

## 1. 总体架构

### 1.1 架构原则
- **服务分离**: STT 和 TTS 服务独立部署，互不干扰
- **代码复用**: 共享基础设施代码（配置、日志、WebSocket等）
- **模块化设计**: 清晰的模块边界，便于维护和扩展
- **高可用性**: 支持水平扩展，故障隔离
- **Provider可配置**: 支持CPU/GPU动态切换，灵活部署

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Web浏览器    │  │  移动应用     │  │  第三方服务   │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
└─────────┼──────────────────┼──────────────────┼─────────────┘
          │                  │                  │
          │ HTTP/WebSocket   │ HTTP/WebSocket   │ REST API
          │                  │                  │
┌─────────┼──────────────────┼──────────────────┼─────────────┐
│         │                  │                  │              │
│  ┌──────▼──────────────────▼──────────────────▼──────┐     │
│  │            API Gateway / Load Balancer              │     │
│  └────────────────────────────────────────────────────┘     │
│                                                               │
│  ┌────────────────────────┐  ┌────────────────────────┐    │
│  │      STT 服务          │  │      TTS 服务          │    │
│  │  (Port: 8080)          │  │  (Port: 8081)          │    │
│  └────────────────────────┘  └────────────────────────────┘    │
└───────────────────────────────────────────────────────────────┘
          │                              │
          │                              │
┌─────────▼──────────────────────────────▼───────────────────┐
│                    共享基础设施层                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  配置管理 │  │  日志系统 │  │ 会话管理  │  │ WebSocket │  │
│  │ +热重载  │  │          │  │ +统计增强 │  │ +优化     │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 限流中间件│  │ Bootstrap│  │  VAD池    │  │  监控统计 │  │
│  │          │  │  启动引导 │  │  管理     │  │          │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└───────────────────────────────────────────────────────────────┘
          │                              │
          │                              │
┌─────────▼──────────────────────────────▼───────────────────┐
│                    业务逻辑层                                │
│  ┌──────────────────┐          ┌──────────────────┐        │
│  │   ASR Manager    │          │   TTS Manager    │        │
│  │  ┌────────────┐  │          │  ┌────────────┐  │        │
│  │  │ ASR Pool   │  │          │  │ TTS Pool   │  │        │
│  │  └────────────┘  │          │  └────────────┘  │        │
│  │  ┌────────────┐  │          │  ┌────────────┐  │        │
│  │  │ ASR Provider│ │          │  │TTS Provider│ │        │
│  │  └────────────┘  │          │  └────────────┘  │        │
│  └──────────────────┘          └──────────────────┘        │
└───────────────────────────────────────────────────────────────┘
          │                              │
          │                              │
┌─────────▼──────────────────────────────▼───────────────────┐
│                    sherpa-onnx 引擎层                       │
│  ┌──────────────────┐          ┌──────────────────┐        │
│  │  ASR C API       │          │  TTS C API       │        │
│  │  (Go Binding)    │          │  (Go Binding)    │        │
│  └──────────────────┘          └──────────────────┘        │
└───────────────────────────────────────────────────────────────┘
          │                              │
          │                              │
┌─────────▼──────────────────────────────▼───────────────────┐
│                  ONNX Runtime 执行层                         │
│  ┌──────────────────┐          ┌──────────────────┐        │
│  │  Provider选择    │          │  Provider选择    │        │
│  │  - CPU           │          │  - CPU           │        │
│  │  - CUDA (GPU)    │          │  - CUDA (GPU)    │        │
│  │  - Auto          │          │  - Auto          │        │
│  └──────────────────┘          └──────────────────┘        │
└───────────────────────────────────────────────────────────────┘
          │                              │
          │                              │
┌─────────▼──────────────────────────────▼───────────────────┐
│                     模型层                                  │
│  ┌──────────────────┐          ┌──────────────────┐        │
│  │  ASR Models      │          │  TTS Models       │        │
│  │  - SenseVoice    │          │  - Kokoro         │        │
│  │  - Paraformer    │          │  - VITS           │        │
│  └──────────────────┘          └──────────────────┘        │
└───────────────────────────────────────────────────────────────┘
          │                              │
          │                              │
┌─────────▼──────────────────────────────▼───────────────────┐
│                   硬件资源层                                │
│  ┌──────────────────┐          ┌──────────────────┐        │
│  │  CPU / GPU       │          │  CPU / GPU       │        │
│  │  (可配置)        │          │  (可配置)        │        │
│  └──────────────────┘          └──────────────────┘        │
└───────────────────────────────────────────────────────────────┘
```

## 2. 模块设计

### 2.1 共享模块 (internal/common)

#### 2.1.1 配置管理 (config)
```go
// 职责：统一配置管理
// 功能：
// - 配置文件加载（JSON/YAML）
// - 环境变量支持
// - 配置热重载
// - 配置验证
// - Provider配置（CPU/GPU）
// - GPU设备选择
```

#### 2.1.2 日志系统 (logger)
```go
// 职责：统一日志管理
// 功能：
// - 多级别日志（Debug/Info/Warn/Error）
// - 日志轮转
// - 结构化日志
// - 日志输出（文件/控制台）
```

#### 2.1.3 会话管理 (session)
```go
// 职责：WebSocket会话管理
// 功能：
// - 会话创建/销毁
// - 会话状态管理
// - 消息队列
// - 会话统计
```

#### 2.1.4 WebSocket处理 (ws)
```go
// 职责：WebSocket连接处理
// 功能：
// - 连接升级
// - 消息路由
// - 错误处理
// - 心跳机制
```

#### 2.1.5 HTTP处理器 (handlers)
```go
// 职责：HTTP请求处理
// 功能：
// - 健康检查
// - 统计信息
// - 监控数据
// - 文件上传
```

### 2.2 ASR模块 (internal/asr)

#### 2.2.1 ASR Manager
```go
// 职责：ASR服务管理
// 功能：
// - 识别器初始化
// - 识别任务调度
// - 性能统计
// - 错误处理
```

#### 2.2.2 ASR Provider
```go
// 职责：sherpa-onnx ASR接口封装
// 功能：
// - 模型加载
// - 音频识别
// - 结果返回
// - 资源释放
```

#### 2.2.3 ASR Pool
```go
// 职责：ASR资源池管理
// 功能：
// - 资源池初始化
// - 资源获取/归还
// - 资源统计
// - 资源清理
```

### 2.3 TTS模块 (internal/tts)

#### 2.3.1 TTS Manager
```go
// 职责：TTS服务管理
// 功能：
// - 合成器初始化
// - 合成任务调度
// - 性能统计
// - 错误处理
```

#### 2.3.2 TTS Provider
```go
// 职责：sherpa-onnx TTS接口封装
// 功能：
// - 模型加载
// - 文本合成
// - 音频生成
// - 资源释放
```

#### 2.3.3 TTS Pool
```go
// 职责：TTS资源池管理
// 功能：
// - 资源池初始化
// - 资源获取/归还
// - 资源统计
// - 资源清理
```

## 3. 数据流设计

### 3.1 STT 数据流

```
客户端音频
    │
    ▼
WebSocket接收
    │
    ▼
会话管理器
    │
    ▼
ASR Manager
    │
    ▼
ASR Pool (获取资源)
    │
    ▼
ASR Provider
    │
    ▼
sherpa-onnx C API
    │
    ▼
识别结果
    │
    ▼
会话管理器
    │
    ▼
WebSocket发送
    │
    ▼
客户端接收
```

### 3.2 TTS 数据流

```
客户端文本
    │
    ▼
HTTP/REST API
    │
    ▼
TTS Manager
    │
    ▼
TTS Pool (获取资源)
    │
    ▼
TTS Provider
    │
    ▼
sherpa-onnx C API
    │
    ▼
音频数据
    │
    ▼
HTTP响应/WebSocket
    │
    ▼
客户端接收
```

## 4. 接口设计

### 4.1 接口抽象

#### 4.1.1 ASR接口
```go
type IASRProvider interface {
    Transcribe(audio []byte) (string, error)
    Warmup() error
    Reset() error
    Release() error
    GetSampleRate() int
}
```

#### 4.1.2 TTS接口
```go
type ITTSProvider interface {
    Synthesize(text string, speakerID int, speed float32) ([]byte, error)
    Warmup() error
    Reset() error
    Release() error
    GetSampleRate() int
}
```

### 4.2 管理器接口

#### 4.2.1 ASR Manager接口
```go
type IASRManager interface {
    Transcribe(audio []byte) (string, error)
    GetStats() Stats
    GetPoolUsage() float64
    GetAvgLatency() time.Duration
}
```

#### 4.2.2 TTS Manager接口
```go
type ITTSManager interface {
    Synthesize(text string, opts TTSOptions) ([]byte, error)
    GetStats() Stats
    GetPoolUsage() float64
    GetAvgLatency() time.Duration
}
```

## 5. 资源管理

### 5.1 资源池设计

#### 5.1.1 ASR资源池
- **池大小**: 根据并发需求配置（默认：每个CPU核心1个）
- **获取策略**: 优先使用空闲资源，无空闲时等待
- **超时机制**: 获取资源超时时间（默认：5秒）
- **清理策略**: 定期清理长时间未使用的资源

#### 5.1.2 TTS资源池
- **池大小**: 较小（默认：5-10个），因为TTS模型较大
- **获取策略**: 同ASR
- **超时机制**: 同ASR
- **清理策略**: 同ASR

### 5.2 会话管理

#### 5.2.1 会话生命周期
```
创建 → 活跃 → 空闲 → 超时 → 销毁
```

#### 5.2.2 会话状态
- **Active**: 正在处理请求
- **Idle**: 空闲状态
- **Timeout**: 超时，等待清理
- **Closed**: 已关闭

## 6. 错误处理

### 6.1 错误分类
- **系统错误**: 服务不可用、资源不足
- **业务错误**: 参数错误、模型加载失败
- **网络错误**: 连接断开、超时
- **客户端错误**: 请求格式错误

### 6.2 错误处理策略
- **重试机制**: 可重试的错误自动重试（最多3次）
- **降级策略**: 服务不可用时返回友好错误信息
- **日志记录**: 所有错误记录详细日志
- **监控告警**: 关键错误触发告警

## 7. 性能优化

### 7.1 并发优化
- **Goroutine池**: 限制并发Goroutine数量
- **资源池**: 复用ASR/TTS资源
- **批量处理**: 支持批量识别/合成

### 7.2 内存优化
- **对象池**: 复用临时对象
- **流式处理**: 大文件流式处理，避免内存溢出
- **及时释放**: 使用完毕后及时释放资源

### 7.3 CPU优化
- **线程数配置**: 根据CPU核心数配置ONNX线程数
- **模型量化**: 使用int8量化模型
- **批处理**: 合并小请求批量处理

## 8. 监控和可观测性

### 8.1 指标收集
- **请求指标**: QPS、延迟、错误率
- **资源指标**: CPU、内存、线程数
- **业务指标**: 识别准确率、合成质量

### 8.2 日志管理
- **结构化日志**: JSON格式，便于分析
- **日志级别**: Debug/Info/Warn/Error
- **日志轮转**: 按大小和时间轮转

### 8.3 追踪
- **请求ID**: 每个请求分配唯一ID
- **链路追踪**: 记录请求完整路径
- **性能分析**: 记录各阶段耗时

## 9. 安全设计

### 9.1 认证授权
- **API Key**: REST API使用API Key认证
- **WebSocket**: 可选的Token认证
- **IP白名单**: 支持IP白名单限制

### 9.2 数据安全
- **传输加密**: HTTPS/WSS
- **数据脱敏**: 日志中敏感信息脱敏
- **访问控制**: 限制访问频率

### 9.3 资源保护
- **限流**: 防止恶意请求
- **超时**: 请求超时自动断开
- **资源限制**: 限制单次请求资源使用

## 10. 扩展性设计

### 10.1 水平扩展
- **无状态设计**: 服务无状态，支持多实例
- **负载均衡**: 支持负载均衡器分发请求
- **服务发现**: 支持服务注册和发现

### 10.2 功能扩展
- **插件机制**: 支持自定义Provider
- **中间件**: 支持请求中间件
- **钩子函数**: 支持生命周期钩子

### 10.3 模型扩展
- **模型热加载**: 支持模型热更新
- **多模型支持**: 支持同时加载多个模型
- **模型切换**: 支持运行时切换模型

