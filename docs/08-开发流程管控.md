# 开发流程管控

## 1. 开发流程概述

### 1.1 流程目标
- 确保代码质量
- 提高开发效率
- 降低bug率
- 保证项目进度

### 1.2 流程阶段
1. **需求分析** → 2. **设计评审** → 3. **编码实现** → 4. **代码审查** → 5. **测试验证** → 6. **合并发布**

## 2. 分支管理策略

### 2.1 分支类型

#### 2.1.1 主分支
- **main**: 生产环境代码，稳定版本
- **develop**: 开发分支，集成所有功能

#### 2.1.2 功能分支
- **feature/xxx**: 新功能开发
  ```
  feature/stt-websocket
  feature/tts-api
  feature/monitor-panel
  ```

#### 2.1.3 修复分支
- **bugfix/xxx**: Bug修复
  ```
  bugfix/memory-leak
  bugfix/websocket-timeout
  ```

#### 2.1.4 发布分支
- **release/xxx**: 版本发布准备
  ```
  release/v1.0.0
  ```

### 2.2 分支工作流

```
main ──────────────●───────────────●───────────────
                    │               │
develop ──────●─────┴─────●─────────┴─────●────────
              │           │               │
feature/xxx ──┘           │               │
                          │               │
feature/yyy ──────────────┘               │
                                          │
bugfix/zzz ───────────────────────────────┘
```

### 2.3 分支命名规范
- **功能分支**: `feature/功能名称`
- **修复分支**: `bugfix/问题描述`
- **发布分支**: `release/版本号`
- **热修复分支**: `hotfix/问题描述`

## 3. 代码提交规范

### 3.1 提交信息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

### 3.2 提交类型
- **feat**: 新功能
- **fix**: Bug修复
- **docs**: 文档更新
- **style**: 代码格式（不影响功能）
- **refactor**: 重构
- **perf**: 性能优化
- **test**: 测试相关
- **chore**: 构建/工具相关
- **ci**: CI配置
- **build**: 构建系统

### 3.3 提交示例
```
feat(asr): add batch recognition support

Add support for batch audio file recognition.
This allows processing multiple files in a single request.

- Add batch recognition endpoint
- Add batch processing logic
- Add batch test cases

Closes #123
```

### 3.4 提交频率
- 每个功能点完成后提交
- 每个测试通过后提交
- 每天至少提交一次
- 避免大量代码一次性提交

## 4. Pull Request流程

### 4.1 PR创建
1. 从develop分支创建功能分支
2. 完成功能开发和测试
3. 提交代码到功能分支
4. 创建Pull Request

### 4.2 PR模板
```markdown
## 变更描述
简要描述本次变更的内容

## 变更类型
- [ ] 新功能
- [ ] Bug修复
- [ ] 性能优化
- [ ] 文档更新
- [ ] 重构
- [ ] GPU支持

## 测试说明
- [ ] 单元测试已通过
- [ ] 集成测试已通过
- [ ] 手动测试已通过
- [ ] 测试覆盖率≥80%
- [ ] GPU测试已通过（如涉及GPU功能）

## 检查清单
- [ ] 代码符合规范
- [ ] 已添加必要的注释
- [ ] 已更新相关文档
- [ ] 无编译错误
- [ ] 无lint错误
- [ ] GPU功能已测试（如涉及GPU功能）
- [ ] GPU回退机制已测试（如涉及GPU功能）

## 相关Issue
Closes #123
```

### 4.3 PR审查
1. **自动检查**:
   - 代码格式检查
   - 单元测试执行
   - 测试覆盖率检查
   - Lint检查

2. **人工审查**:
   - 代码逻辑审查
   - 代码风格审查
   - 性能影响评估
   - 安全性审查

### 4.4 PR合并
- 至少1人审查通过
- 所有自动检查通过
- 测试覆盖率≥80%
- 无冲突

## 5. 代码审查规范

### 5.1 审查清单
- [ ] 代码符合Go语言规范
- [ ] 错误处理完整
- [ ] 并发安全
- [ ] 资源正确释放
- [ ] 有适当的注释
- [ ] 有单元测试
- [ ] 测试覆盖率≥80%
- [ ] 无明显的性能问题
- [ ] 无安全隐患

### 5.2 审查重点
- **功能正确性**: 代码是否实现预期功能
- **代码质量**: 代码是否清晰、可维护
- **性能影响**: 是否影响系统性能
- **安全性**: 是否存在安全隐患
- **测试覆盖**: 是否有足够的测试

### 5.3 审查反馈
- 使用友好的语言
- 提供具体的建议
- 解释为什么需要修改
- 及时响应审查意见

## 6. 持续集成(CI)

### 6.1 CI流程
```
代码提交 → 触发CI → 代码检查 → 单元测试 → 集成测试 → 覆盖率检查 → 构建 → 部署测试环境
```

### 6.2 CI配置
```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.21'
      
      - name: Run gofmt
        run: gofmt -l .
      
      - name: Run golint
        run: golint ./...
      
      - name: Run tests
        run: go test -v -coverprofile=coverage.out ./...
      
      - name: Check coverage
        run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "Coverage $coverage% is below 80%"
            exit 1
          fi
      
      - name: Upload coverage
        uses: codecov/codecov-action@v2
        with:
          file: ./coverage.out
```

### 6.3 CI检查项
- 代码格式检查（gofmt）
- 代码规范检查（golint）
- 单元测试执行
- 测试覆盖率检查（≥80%）
- 构建检查
- 安全扫描

## 7. 版本发布流程

### 7.1 版本号规范
- **主版本号**: 不兼容的API修改
- **次版本号**: 向后兼容的功能新增
- **修订号**: 向后兼容的问题修正

格式: `v<major>.<minor>.<patch>`
示例: `v1.0.0`, `v1.1.0`, `v1.1.1`

### 7.2 发布流程
1. **准备发布分支**
   ```bash
   git checkout develop
   git pull
   git checkout -b release/v1.0.0
   ```

2. **更新版本号**
   - 更新go.mod版本
   - 更新CHANGELOG.md
   - 更新README.md

3. **测试验证**
   - 运行所有测试
   - 手动测试
   - 性能测试

4. **合并到main**
   ```bash
   git checkout main
   git merge release/v1.0.0
   git tag v1.0.0
   git push origin main --tags
   ```

5. **合并回develop**
   ```bash
   git checkout develop
   git merge release/v1.0.0
   git push origin develop
   ```

### 7.3 发布检查清单
- [ ] 所有测试通过
- [ ] 测试覆盖率≥80%
- [ ] 文档已更新
- [ ] CHANGELOG已更新
- [ ] 版本号已更新
- [ ] 构建成功
- [ ] 部署测试通过

## 8. 问题跟踪

### 8.1 Issue管理
- **Bug报告**: 使用bug模板
- **功能请求**: 使用feature模板
- **问题分类**: bug/feature/question/documentation

### 8.2 Issue标签
- `bug`: Bug报告
- `feature`: 功能请求
- `enhancement`: 功能增强
- `question`: 问题咨询
- `documentation`: 文档相关
- `priority:high`: 高优先级
- `priority:low`: 低优先级

### 8.3 Issue处理流程
```
创建Issue → 分类标签 → 分配负责人 → 开发修复 → 测试验证 → 关闭Issue
```

## 9. 文档管理

### 9.1 文档类型
- **技术文档**: 架构设计、API文档
- **用户文档**: 使用手册、快速开始
- **开发文档**: 开发规范、测试规范
- **部署文档**: 部署指南、运维手册

### 9.2 文档更新
- 代码变更时同步更新文档
- PR中必须包含文档更新
- 定期审查文档准确性

### 9.3 文档版本
- 文档与代码版本同步
- 重要变更记录在CHANGELOG中

## 10. 质量保证

### 10.1 代码质量
- 代码审查
- 静态代码分析
- 代码规范检查
- 测试覆盖率检查

### 10.2 功能质量
- 功能测试
- 集成测试
- 性能测试
- 压力测试

### 10.3 文档质量
- 文档审查
- 文档完整性检查
- 文档准确性验证

## 11. 进度管理

### 11.1 任务分解
- 将大任务分解为小任务
- 每个任务可独立完成
- 任务时间估算

### 11.2 进度跟踪
- 使用项目管理工具（如GitHub Projects）
- 每周进度检查
- 及时调整计划

### 11.3 里程碑管理
- 设定关键里程碑
- 里程碑验收标准
- 里程碑评审

## 12. 沟通协作

### 12.1 日常沟通
- 每日站会（可选）
- 代码审查讨论
- Issue讨论

### 12.2 技术讨论
- 设计评审会议
- 技术方案讨论
- 问题解决方案讨论

### 12.3 文档记录
- 重要决策记录
- 技术方案文档
- 会议纪要

## 13. 风险管理

### 13.1 风险识别
- 技术风险
- 进度风险
- 质量风险

### 13.2 风险应对
- 提前识别风险
- 制定应对方案
- 及时调整计划

### 13.3 风险跟踪
- 风险清单
- 风险状态跟踪
- 风险解决记录

