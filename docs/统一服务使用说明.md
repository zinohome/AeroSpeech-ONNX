# 统一服务使用说明

## 概述

统一服务（`cmd/speech-server`）支持两种部署模式：
- **统一模式（unified）**: STT和TTS在同一个端口
- **分离模式（separated）**: STT和TTS分别在不同端口（通过配置选择启用）

## 配置说明

### 统一配置文件

配置文件路径：`configs/speech-config.json`

```json
{
  "mode": "unified",
  "server": {
    "host": "0.0.0.0",
    "port": 8080,
    "read_timeout": 20
  },
  "stt": {
    "model_path": "models/asr/...",
    "tokens_path": "models/asr/...",
    "language": "zh",
    "provider": {
      "provider": "cpu",
      "device_id": 0,
      "num_threads": 4
    }
  },
  "tts": {
    "model_path": "models/tts/...",
    "voices_path": "models/tts/...",
    "tokens_path": "models/tts/...",
    "data_dir": "models/tts/...",
    "provider": {
      "provider": "cpu",
      "device_id": 0,
      "num_threads": 4
    }
  },
  "audio": { ... },
  "websocket": { ... },
  "session": { ... },
  "logging": { ... }
}
```

### 配置项说明

- **mode**: `"unified"` 或 `"separated"`
  - `unified`: 统一模式，STT和TTS在同一端口
  - `separated`: 分离模式（当前未实现，保留用于未来扩展）

- **stt**: STT配置（可选，如果不需要STT可以省略）
- **tts**: TTS配置（可选，如果不需要TTS可以省略）

## 运行方式

### 1. 统一模式（推荐用于开发/测试）

```bash
# 复制配置文件
cp configs/speech-config.example.json configs/speech-config.json

# 编辑配置文件，设置模型路径

# 运行服务
go run cmd/speech-server/main.go
```

### 2. 环境变量配置

```bash
export SPEECH_CONFIG_PATH=/path/to/speech-config.json
go run cmd/speech-server/main.go
```

## API端点

### REST API

#### STT API
- `POST /api/v1/stt/recognize` - 文件上传识别
- `POST /api/v1/stt/batch` - 批量识别
- `GET /api/v1/stt/config` - 获取配置
- `GET /api/v1/stt/stats` - 获取统计信息

#### TTS API
- `POST /api/v1/tts/synthesize` - 文本合成
- `POST /api/v1/tts/batch` - 批量合成
- `GET /api/v1/tts/speakers` - 获取说话人列表
- `GET /api/v1/tts/config` - 获取配置
- `GET /api/v1/tts/stats` - 获取统计信息

#### 通用API
- `GET /api/v1/health` - 健康检查
- `GET /api/v1/stats` - 统计信息
- `GET /api/v1/monitor` - 监控数据

### WebSocket API

#### STT WebSocket
- `ws://localhost:8080/ws/stt` - STT实时识别

#### TTS WebSocket
- `ws://localhost:8080/ws/tts` - TTS实时合成

#### 兼容路由（统一模式）
- `ws://localhost:8080/ws?type=stt` - STT（默认）
- `ws://localhost:8080/ws?type=tts` - TTS

### Web界面

- `http://localhost:8080/` - 默认页面（STT或TTS）
- `http://localhost:8080/stt` - STT测试页面
- `http://localhost:8080/tts` - TTS测试页面
- `http://localhost:8080/monitor` - 监控面板

## 使用场景

### 统一模式适用场景

1. **开发/测试环境**
   - 简化部署
   - 快速启动
   - 资源充足

2. **小规模部署**
   - 资源有限
   - 负载不高
   - 不需要独立扩展

3. **一体化应用**
   - STT和TTS总是同时使用
   - 简化客户端集成

### 分离模式适用场景

1. **生产环境大规模部署**
   - 需要独立扩展
   - 需要故障隔离
   - 需要资源优化

2. **不同负载特征**
   - STT和TTS负载差异大
   - 需要不同的资源配置

3. **高可用性要求**
   - 需要故障隔离
   - 需要独立监控

## 与分离服务的对比

| 特性 | 统一服务 | 分离服务 |
|------|---------|---------|
| 端口数 | 1个 | 2个 |
| 进程数 | 1个 | 2个 |
| 部署复杂度 | 简单 | 中等 |
| 故障隔离 | 无 | 有 |
| 独立扩展 | 不支持 | 支持 |
| 资源优化 | 一般 | 优秀 |
| 适用场景 | 开发/测试/小规模 | 生产/大规模 |

## 注意事项

1. **统一模式必须同时配置STT和TTS**
   - 如果只需要STT或TTS，建议使用分离服务

2. **资源竞争**
   - 统一模式下，STT和TTS可能竞争CPU/GPU资源
   - 建议合理配置资源池大小

3. **故障影响**
   - 统一模式下，一个服务崩溃会影响另一个
   - 生产环境建议使用分离服务

4. **配置验证**
   - 统一模式会自动验证STT和TTS配置
   - 如果配置错误，服务无法启动

## 迁移指南

### 从分离服务迁移到统一服务

1. **合并配置文件**
   ```bash
   # 参考 speech-config.example.json
   # 合并 stt-config.json 和 tts-config.json
   ```

2. **更新客户端**
   - 更新API端点路径
   - 更新WebSocket连接路径

3. **测试验证**
   - 验证所有API功能
   - 验证WebSocket连接
   - 验证性能指标

### 从统一服务迁移到分离服务

1. **拆分配置文件**
   ```bash
   # 从 speech-config.json 提取STT配置到 stt-config.json
   # 从 speech-config.json 提取TTS配置到 tts-config.json
   ```

2. **启动分离服务**
   ```bash
   go run cmd/stt-server/main.go
   go run cmd/tts-server/main.go
   ```

3. **更新客户端**
   - 更新端口号
   - 更新API端点

## 故障排查

### 常见问题

1. **配置加载失败**
   - 检查配置文件路径
   - 检查配置文件格式
   - 检查模型文件路径

2. **服务启动失败**
   - 检查端口是否被占用
   - 检查模型文件是否存在
   - 检查日志输出

3. **WebSocket连接失败**
   - 检查WebSocket路径是否正确
   - 检查防火墙设置
   - 检查服务是否正常运行

## 性能建议

1. **资源池配置**
   - STT池大小：根据CPU核心数配置
   - TTS池大小：建议5-10个（模型较大）

2. **Provider选择**
   - CPU模式：适合小规模部署
   - CUDA模式：适合大规模部署，性能提升3-5倍

3. **并发控制**
   - 根据实际负载调整资源池大小
   - 监控资源使用情况

## 总结

统一服务提供了灵活的部署选项，可以根据实际需求选择：
- **开发/测试环境**: 使用统一模式，简化部署
- **生产环境**: 使用分离服务，提供更好的可靠性和扩展性

两种模式都完全兼容现有的API和WebSocket接口，可以无缝切换。

