# ğŸ¤ Piper TTS æ¨¡å‹å¿«é€Ÿå¼€å§‹

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¨¡å‹æ–‡ä»¶ä¸‹è½½ âœ…
```
models/tts/vits-piper-zh_CN-huayan-medium/
â”œâ”€â”€ zh_CN-huayan-medium.onnx          (60 MB)
â”œâ”€â”€ zh_CN-huayan-medium.onnx.json     (4.7 KB)
â”œâ”€â”€ tokens.txt                         (907 B)
â””â”€â”€ espeak-ng-data/                    (å·²å¤åˆ¶)
```

### 2. ä»£ç æ”¯æŒ âœ…
- å·²æ›´æ–° `internal/tts/provider.go` æ”¯æŒ VITS/Piper æ¨¡å‹
- è‡ªåŠ¨æ£€æµ‹æ¨¡å‹ç±»å‹ï¼ˆKokoro/VITSï¼‰
- è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„é‡‡æ ·ç‡

### 3. é…ç½®æ–‡ä»¶ âœ…
- å·²åˆ›å»º `configs/speech-config-piper.example.json`
- é‡‡æ ·ç‡å·²æ­£ç¡®è®¾ç½®ä¸º 22050 Hz

### 4. æµ‹è¯•è„šæœ¬ âœ…
- å·²åˆ›å»º `scripts/test_piper_model.sh`
- å¯æµ‹è¯•ä¸åŒæ–‡æœ¬å’Œè¯­é€Ÿ

### 5. æ–‡æ¡£ âœ…
- å·²åˆ›å»º `docs/17-Piperæ¨¡å‹ä½¿ç”¨æŒ‡å—.md`
- åŒ…å«è¯¦ç»†çš„é…ç½®ã€ä½¿ç”¨å’Œæ•…éšœæ’æŸ¥

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥ï¼‰

### ç¬¬1æ­¥: å¯åŠ¨æœåŠ¡å™¨

```bash
cd /Users/zhangjun/CursorProjects/AeroSpeech-ONNX

# ä½¿ç”¨ Piper é…ç½®å¯åŠ¨
./speech-server --config configs/speech-config-piper.example.json
```

**é¢„æœŸè¾“å‡º**:
```
2024/11/16 13:10:00 [INFO] Loading TTS model from models/tts/vits-piper-zh_CN-huayan-medium/zh_CN-huayan-medium.onnx
2024/11/16 13:10:02 [INFO] TTS model loaded successfully (sample rate: 22050)
2024/11/16 13:10:02 [INFO] Server listening on 0.0.0.0:8780
```

### ç¬¬2æ­¥: æµ‹è¯• API

åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œï¼š

```bash
# å¿«é€Ÿæµ‹è¯•
curl -X POST http://localhost:8780/api/v1/tts/synthesize \
  -H "Content-Type: application/json" \
  -d '{"text":"ä½ å¥½ï¼Œæˆ‘æ˜¯åç ”ã€‚è¿™æ˜¯è¯­éŸ³åˆæˆæµ‹è¯•ã€‚","speaker_id":0,"speed":1.0}' \
  --output test_piper.wav && afplay test_piper.wav
```

### ç¬¬3æ­¥: å®Œæ•´æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•è„šæœ¬
./scripts/test_piper_model.sh
```

è¿™å°†æµ‹è¯•ï¼š
- 5ä¸ªä¸åŒçš„æ–‡æœ¬å†…å®¹
- 5ç§ä¸åŒçš„è¯­é€Ÿ (0.8, 0.9, 1.0, 1.1, 1.2)
- æ‰€æœ‰éŸ³é¢‘ä¿å­˜åœ¨ `piper_test_output/`

---

## ğŸ¯ æµ‹è¯•è¦ç‚¹

### å¬ä»€ä¹ˆï¼Ÿ

1. **éŸ³è´¨** - æ˜¯å¦æ¸…æ™°è‡ªç„¶ï¼Ÿ
2. **å‘éŸ³** - ä¸­æ–‡å‘éŸ³æ˜¯å¦å‡†ç¡®ï¼Ÿ
3. **è¯­é€Ÿ** - å“ªä¸ªè¯­é€Ÿæœ€åˆé€‚ï¼Ÿï¼ˆå»ºè®® 0.9-1.0ï¼‰
4. **è‡ªç„¶åº¦** - æ˜¯å¦æ¯” Kokoro æ›´è‡ªç„¶ï¼Ÿ

### å¯¹æ¯” Kokoro v1.1

| é¡¹ç›® | Piper | Kokoro v1.1 | å»ºè®® |
|------|-------|-------------|------|
| **ä¸­æ–‡å‘éŸ³** | çº¯ä¸­æ–‡è®­ç»ƒ | å¤šè¯­è¨€è®­ç»ƒ | çº¯ä¸­æ–‡åœºæ™¯é€‰ Piper |
| **è¯´è¯äººæ•°** | 1ä¸ªå¥³å£° | 103ä¸ª | éœ€è¦å¤šéŸ³è‰²é€‰ Kokoro |
| **é‡‡æ ·ç‡** | 22050 Hz | 24000 Hz | éŸ³è´¨è¦æ±‚é«˜é€‰ Kokoro |
| **æ¨¡å‹å¤§å°** | 60 MB | 310 MB | èµ„æºå—é™é€‰ Piper |
| **åŠ è½½é€Ÿåº¦** | å¿« | æ…¢ | å¯åŠ¨é€Ÿåº¦è¦æ±‚é«˜é€‰ Piper |
| **è‹±æ–‡æ”¯æŒ** | âŒ | âœ… | éœ€è¦è‹±æ–‡é€‰ Kokoro |

---

## ğŸ“Š å¸¸è§é—®é¢˜

### Q1: å£°éŸ³å¬èµ·æ¥æ€ªå¼‚ï¼Ÿ

**æ£€æŸ¥é‡‡æ ·ç‡é…ç½®**:
```json
{
  "audio": {
    "sample_rate": 22050  // å¿…é¡»æ˜¯ 22050ï¼Œä¸æ˜¯ 24000
  }
}
```

### Q2: å¦‚ä½•è°ƒæ•´éŸ³è´¨ï¼Ÿ

```bash
# å°è¯•ä¸åŒè¯­é€Ÿ
# 0.8-0.9: æ›´ä»å®¹ï¼Œæ›´æ¸…æ™°
# 1.0: æ ‡å‡†é€Ÿåº¦
# 1.1-1.2: æ›´å¿«ï¼Œæ›´ç´§å‡‘

# æ¨è: 0.9
curl -X POST http://localhost:8780/api/v1/tts/synthesize \
  -d '{"text":"æµ‹è¯•","speaker_id":0,"speed":0.9}'
```

### Q3: å‘éŸ³ä¸å‡†ç¡®ï¼Ÿ

**ä¼˜åŒ–æ–‡æœ¬**:
```json
{
  "text": "ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œæ¸©åº¦æ˜¯ äºŒåä¸‰ æ‘„æ°åº¦ã€‚"  // âœ… æ·»åŠ æ ‡ç‚¹å’Œç©ºæ ¼
}

{
  "text": "ä»Šå¤©å¤©æ°”çœŸä¸é”™æ¸©åº¦æ˜¯23æ‘„æ°åº¦"  // âŒ ç¼ºå°‘æ ‡ç‚¹
}
```

### Q4: æƒ³åˆ‡æ¢å› Kokoroï¼Ÿ

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶
{
  "tts": {
    "model_path": "models/tts/kokoro-multi-lang-v1_1/model.onnx",
    "voices_path": "models/tts/kokoro-multi-lang-v1_1/voices.bin",
    "tokens_path": "models/tts/kokoro-multi-lang-v1_1/tokens.txt",
    "data_dir": "models/tts/kokoro-multi-lang-v1_1/espeak-ng-data"
  },
  "audio": {
    "sample_rate": 24000  // æ”¹å› 24000
  }
}

# é‡å¯æœåŠ¡å™¨
```

---

## ğŸ¨ ä½¿ç”¨åœºæ™¯æ¨è

### âœ… é€‚åˆ Piper çš„åœºæ™¯ï¼š

1. **çº¯ä¸­æ–‡åº”ç”¨**
   - ä¸­æ–‡å®¢æœç³»ç»Ÿ
   - ä¸­æ–‡æ’­æŠ¥ç³»ç»Ÿ
   - ä¸­æ–‡è¯­éŸ³åŠ©æ‰‹

2. **èµ„æºå—é™ç¯å¢ƒ**
   - åµŒå…¥å¼è®¾å¤‡
   - ç§»åŠ¨åº”ç”¨
   - Docker å®¹å™¨

3. **å¿«é€Ÿå“åº”éœ€æ±‚**
   - å®æ—¶å¯¹è¯
   - å³æ—¶é€šçŸ¥
   - å¿«é€Ÿåé¦ˆ

4. **å•ä¸€éŸ³è‰²åœºæ™¯**
   - ç»Ÿä¸€çš„å“ç‰Œå£°éŸ³
   - å›ºå®šçš„è§’è‰²å£°éŸ³

### âŒ ä¸é€‚åˆ Piper çš„åœºæ™¯ï¼š

1. éœ€è¦å¤šä¸ªè¯´è¯äººé€‰æ‹©
2. éœ€è¦ä¸­è‹±æ–‡æ··åˆ
3. éœ€è¦ç”·å£°
4. å¯¹éŸ³è´¨è¦æ±‚æé«˜

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–

```json
{
  "tts": {
    "provider": {
      "provider": "cpu",
      "num_threads": 4  // æ ¹æ® CPU è°ƒæ•´
    }
  }
}
```

### 2. æ–‡æœ¬é¢„å¤„ç†

```python
def preprocess_text(text):
    # 1. æ•°å­—è½¬ä¸­æ–‡
    text = text.replace("1", "ä¸€")
    text = text.replace("2", "äºŒ")
    # ...
    
    # 2. æ·»åŠ æ ‡ç‚¹
    # 3. åˆ†å¥
    
    return text
```

### 3. æ‰¹é‡å¤„ç†

```bash
# æ‰¹é‡åˆæˆ
while read line; do
    curl -X POST http://localhost:8780/api/v1/tts/synthesize \
      -d "{\"text\":\"${line}\"}" \
      -o "output_$(md5 -qs "$line").wav"
done < texts.txt
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Piper æ¨¡å‹è¯¦ç»†æŒ‡å—](docs/17-Piperæ¨¡å‹ä½¿ç”¨æŒ‡å—.md)
- [TTS é…ç½®ä¼˜åŒ–](docs/14-TTSé…ç½®ä¼˜åŒ–æŒ‡å—.md)
- [æ›¿ä»£æ¨¡å‹æŒ‡å—](docs/16-æ›¿ä»£TTSæ¨¡å‹æŒ‡å—.md)
- [æ¨¡å‹ä¸‹è½½è„šæœ¬](scripts/download_models.sh)

---

## ğŸ¯ å†³ç­–æµç¨‹å›¾

```
éœ€è¦ä½¿ç”¨ TTS
    â†“
    æ˜¯å¦çº¯ä¸­æ–‡åº”ç”¨ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ˜¯å¦éœ€è¦å¤šä¸ªè¯´è¯äººï¼Ÿ
    â”‚       â”œâ”€ å¦ â†’ æ˜¯å¦èµ„æºå—é™ï¼Ÿ
    â”‚       â”‚       â”œâ”€ æ˜¯ â†’ âœ… ä½¿ç”¨ Piper
    â”‚       â”‚       â””â”€ å¦ â†’ å¯¹æ¯”æµ‹è¯•
    â”‚       â””â”€ æ˜¯ â†’ âœ… ä½¿ç”¨ Kokoro (103ä¸ªè¯´è¯äºº)
    â””â”€ å¦ â†’ âœ… ä½¿ç”¨ Kokoro (æ”¯æŒä¸­è‹±æ–‡)
```

---

## ğŸ æ€»ç»“

**Piper åç ”å¥³å£°** æ˜¯ä¸€ä¸ªï¼š
- âœ… è½»é‡çº§ (60 MB)
- âœ… å¿«é€Ÿ (åŠ è½½å¿«ã€åˆæˆå¿«)
- âœ… çº¯ä¸­æ–‡ä¼˜åŒ–
- âœ… éŸ³è´¨è‡ªç„¶
- âœ… é€‚åˆèµ„æºå—é™ç¯å¢ƒ

**å»ºè®®**ï¼š
1. å…ˆç”¨æµ‹è¯•è„šæœ¬è¯•å¬
2. å¯¹æ¯” Kokoro v1.1
3. æ ¹æ®æ‚¨çš„å…·ä½“åœºæ™¯é€‰æ‹©
4. å¦‚æœæ»¡æ„ï¼Œåˆ‡æ¢åˆ° Piper é…ç½®

**ä¸‹ä¸€æ­¥**ï¼š
```bash
# å¯åŠ¨æœåŠ¡å™¨æµ‹è¯•
./speech-server --config configs/speech-config-piper.example.json

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•
./scripts/test_piper_model.sh

# å‘Šè¯‰æˆ‘æ‚¨çš„æµ‹è¯•ç»“æœï¼ğŸ˜Š
```

---

éœ€è¦å¸®åŠ©ï¼ŸæŸ¥çœ‹ `docs/17-Piperæ¨¡å‹ä½¿ç”¨æŒ‡å—.md` è·å–è¯¦ç»†ä¿¡æ¯ï¼

